rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ─────────────────────────────────────────
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // Check if user is a member of a campaign (reads the members subcollection)
    function isCampaignMember(campaignId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/campaigns/$(campaignId)/members/$(request.auth.uid));
    }

    // Check if user is the DM of a campaign
    function isCampaignDM(campaignId) {
      return isSignedIn()
        && get(/databases/$(database)/documents/campaigns/$(campaignId)).data.dmId == request.auth.uid;
    }

    // ── Characters collection ────────────────────────────────────
    match /characters/{charId} {
      allow read: if isSignedIn()
                  && resource.data.ownerUid == request.auth.uid;

      allow create: if isSignedIn()
                    && request.resource.data.ownerUid == request.auth.uid
                    // Hard cap: 900 KB per character doc to prevent storage abuse
                    && request.resource.size() < 921600
                    // Core field type validation
                    && request.resource.data.ownerUid is string
                    && request.resource.data.name is string
                    && request.resource.data.level is int;

      allow update: if isSignedIn()
                    && resource.data.ownerUid == request.auth.uid
                    && request.resource.data.ownerUid == request.auth.uid
                    && request.resource.size() < 921600
                    && request.resource.data.ownerUid is string
                    && request.resource.data.name is string
                    && request.resource.data.level is int;

      allow delete: if isSignedIn()
                    && resource.data.ownerUid == request.auth.uid;
    }

    // ── Campaigns collection ─────────────────────────────────────
    match /campaigns/{campaignId} {
      // Any signed-in user can read campaigns (needed for join-by-code queries)
      allow read: if isSignedIn();

      // Any signed-in user can create a campaign (they become the DM)
      allow create: if isSignedIn()
                    && request.resource.data.dmId == request.auth.uid;

      // Only the DM can update campaign settings
      allow update: if isCampaignDM(campaignId);

      // Only the DM can delete (archive) a campaign
      allow delete: if isCampaignDM(campaignId);

      // ── Members subcollection ────────────────────────────────
      match /members/{memberId} {
        // All campaign members can read the member list; DM always has access
        allow read: if isCampaignMember(campaignId) || isCampaignDM(campaignId);

        // Users can add themselves (join) or the DM can add anyone
        allow create: if isSignedIn()
                      && (request.auth.uid == memberId || isCampaignDM(campaignId));

        // Members can update their own doc (restricted fields); DM can update any field
        allow update: if isCampaignDM(campaignId)
                      || (isSignedIn()
                          && request.auth.uid == memberId
                          // Members may only update their linked character and role — not e.g. uid
                          && request.resource.data.diff(resource.data).affectedKeys()
                               .hasOnly(['characterId', 'character', 'role', 'updatedAt']));

        // Members can remove themselves; DM can remove anyone
        allow delete: if isSignedIn()
                      && (request.auth.uid == memberId || isCampaignDM(campaignId));
      }

      // ── Encounters subcollection ─────────────────────────────
      match /encounters/{encounterId} {
        // All members can read encounters; DM always has access
        allow read: if isCampaignMember(campaignId) || isCampaignDM(campaignId);

        // Only DM can create/update/delete encounters
        allow create: if isCampaignDM(campaignId);
        allow update: if isCampaignDM(campaignId);
        allow delete: if isCampaignDM(campaignId);
      }

      // ── DM Notes subcollection ───────────────────────────────
      match /notes/{noteId} {
        // Only DM can read/write DM notes
        allow read: if isCampaignDM(campaignId);
        allow create: if isCampaignDM(campaignId);
        allow update: if isCampaignDM(campaignId);
        allow delete: if isCampaignDM(campaignId);
      }

      // ── Encounter Templates subcollection ────────────────────
      match /templates/{templateId} {
        // Only DM can manage templates
        allow read: if isCampaignDM(campaignId);
        allow create: if isCampaignDM(campaignId);
        allow update: if isCampaignDM(campaignId);
        allow delete: if isCampaignDM(campaignId);
      }

      // ── Whispers subcollection ───────────────────────────────
      match /whispers/{whisperId} {
        // Users can read whispers sent TO/FROM them; DM can read all (for cleanup)
        allow read: if isSignedIn()
                    && (resource.data.toUid == request.auth.uid
                        || resource.data.fromUid == request.auth.uid
                        || isCampaignDM(campaignId));

        // Members can create whispers
        allow create: if isCampaignMember(campaignId)
                      && request.resource.data.fromUid == request.auth.uid;

        // Only the recipient can update (mark as read)
        allow update: if isSignedIn()
                      && resource.data.toUid == request.auth.uid;

        // Only the DM can delete whispers (campaign cleanup)
        allow delete: if isCampaignDM(campaignId);
      }

      // ── Roll Requests subcollection ──────────────────────────
      match /rollRequests/{requestId} {
        // All members can read roll requests; DM always has access
        allow read: if isCampaignMember(campaignId) || isCampaignDM(campaignId);

        // Only DM can create roll requests
        allow create: if isCampaignDM(campaignId);

        // Members can only write their own response entry; DM can update anything
        allow update: if isCampaignDM(campaignId)
                      || (isCampaignMember(campaignId)
                          // Only allow writing 'responses' and 'updatedAt' — prevents members
                          // from altering the DM's roll request definition
                          && request.resource.data.diff(resource.data).affectedKeys()
                               .hasOnly(['responses', 'updatedAt']));

        allow delete: if isCampaignDM(campaignId);
      }
    }

    // ── Invites collection (top-level) ───────────────────────────
    match /invites/{inviteId} {
      // Users can only read invites addressed to them or created by them
      // (prevents harvesting email addresses of other users)
      allow read: if isSignedIn()
                  && (resource.data.email == request.auth.token.email
                      || resource.data.invitedByUid == request.auth.uid);

      // Any signed-in user can create invites
      allow create: if isSignedIn()
                    && request.resource.data.invitedByUid == request.auth.uid;

      // Only the invite recipient or the campaign DM can update (accept/decline)
      allow update: if isSignedIn()
                    && (resource.data.toEmail == request.auth.token.email
                        || resource.data.invitedByUid == request.auth.uid);

      allow delete: if false; // Invites are permanent records
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ─────────────────────────────────────────
    function isSignedIn() {
      return request.auth != null;
    }

    // Check if user is a member of a campaign (reads the members subcollection)
    function isCampaignMember(campaignId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/campaigns/$(campaignId)/members/$(request.auth.uid));
    }

    // Check if user is the DM of a campaign
    function isCampaignDM(campaignId) {
      return isSignedIn()
        && get(/databases/$(database)/documents/campaigns/$(campaignId)).data.dmId == request.auth.uid;
    }

    // ── Characters collection ────────────────────────────────────
    match /characters/{charId} {
      allow read: if isSignedIn()
                  && resource.data.ownerUid == request.auth.uid;

      allow create: if isSignedIn()
                    && request.resource.data.ownerUid == request.auth.uid;

      allow update: if isSignedIn()
                    && resource.data.ownerUid == request.auth.uid
                    && request.resource.data.ownerUid == request.auth.uid;

      allow delete: if isSignedIn()
                    && resource.data.ownerUid == request.auth.uid;
    }

    // ── Campaigns collection ─────────────────────────────────────
    match /campaigns/{campaignId} {
      // Any signed-in user can read campaigns (needed for join-by-code queries)
      allow read: if isSignedIn();

      // Any signed-in user can create a campaign (they become the DM)
      allow create: if isSignedIn()
                    && request.resource.data.dmId == request.auth.uid;

      // Only the DM can update campaign settings.
      // Members can also update ONLY memberUids + updatedAt (client-side fallback for join/leave).
      allow update: if isCampaignDM(campaignId)
                    || (isCampaignMember(campaignId)
                        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberUids', 'updatedAt']));

      // Only the DM can delete (archive) a campaign
      allow delete: if isCampaignDM(campaignId);

      // ── Members subcollection ────────────────────────────────
      match /members/{memberId} {
        // All campaign members can read the member list; DM always has access.
        // Users can also read their OWN member doc (needed for join-flow duplicate check).
        allow read: if isCampaignMember(campaignId)
                    || isCampaignDM(campaignId)
                    || (isSignedIn() && request.auth.uid == memberId);

        // Users can add themselves (join) or the DM can add anyone
        allow create: if isSignedIn()
                      && (request.auth.uid == memberId || isCampaignDM(campaignId));

        // Members can update their own doc; DM can update any member
        allow update: if isSignedIn()
                      && (request.auth.uid == memberId || isCampaignDM(campaignId));

        // Members can remove themselves; DM can remove anyone
        allow delete: if isSignedIn()
                      && (request.auth.uid == memberId || isCampaignDM(campaignId));
      }

      // ── Encounters subcollection ─────────────────────────────
      match /encounters/{encounterId} {
        // All members can read encounters; DM always has access
        allow read: if isCampaignMember(campaignId) || isCampaignDM(campaignId);

        // Only DM can create/update/delete encounters
        allow create: if isCampaignDM(campaignId);
        allow update: if isCampaignDM(campaignId);
        allow delete: if isCampaignDM(campaignId);
      }

      // ── DM Notes subcollection ───────────────────────────────
      match /notes/{noteId} {
        // Only DM can read/write DM notes
        allow read: if isCampaignDM(campaignId);
        allow create: if isCampaignDM(campaignId);
        allow update: if isCampaignDM(campaignId);
        allow delete: if isCampaignDM(campaignId);
      }

      // ── Encounter Templates subcollection ────────────────────
      match /templates/{templateId} {
        // Only DM can manage templates
        allow read: if isCampaignDM(campaignId);
        allow create: if isCampaignDM(campaignId);
        allow update: if isCampaignDM(campaignId);
        allow delete: if isCampaignDM(campaignId);
      }

      // ── Whispers subcollection ───────────────────────────────
      match /whispers/{whisperId} {
        // Users can read whispers sent TO/FROM them; DM can read all (for cleanup)
        allow read: if isSignedIn()
                    && (resource.data.toUid == request.auth.uid
                        || resource.data.fromUid == request.auth.uid
                        || isCampaignDM(campaignId));

        // Members can create whispers
        allow create: if isCampaignMember(campaignId)
                      && request.resource.data.fromUid == request.auth.uid;

        // Only the recipient can update (mark as read)
        allow update: if isSignedIn()
                      && resource.data.toUid == request.auth.uid;

        // Only the DM can delete whispers (campaign cleanup)
        allow delete: if isCampaignDM(campaignId);
      }

      // ── Channel Messages subcollection ───────────────────────
      match /messages/{messageId} {
        // Round table is visible to all campaign members.
        // Party private is visible only to non-DM members.
        allow read: if isCampaignMember(campaignId)
                    && (
                      resource.data.channel == 'round_table'
                      || (resource.data.channel == 'party_private' && !isCampaignDM(campaignId))
                    );

        // Members can post as themselves.
        // DM may post only in round_table.
        allow create: if isCampaignMember(campaignId)
                      && request.resource.data.fromUid == request.auth.uid
                      && (
                        request.resource.data.channel == 'round_table'
                        || (request.resource.data.channel == 'party_private' && !isCampaignDM(campaignId))
                      );

        // Messages are immutable (prevents silent edits/deletes in chat history).
        allow update, delete: if false;
      }

      // ── Roll Requests subcollection ──────────────────────────
      match /rollRequests/{requestId} {
        // All members can read roll requests; DM always has access
        allow read: if isCampaignMember(campaignId) || isCampaignDM(campaignId);

        // Only DM can create roll requests
        allow create: if isCampaignDM(campaignId);

        // Any member can update (to submit their response)
        allow update: if isCampaignMember(campaignId);

        allow delete: if isCampaignDM(campaignId);
      }
    }

    // ── Invites collection (top-level) ───────────────────────────
    match /invites/{inviteId} {
      // Users can read invites addressed to their email
      allow read: if isSignedIn();

      // Any signed-in user can create invites
      allow create: if isSignedIn()
                    && request.resource.data.invitedByUid == request.auth.uid;

      // Only the invite recipient or the invite creator can update (accept/decline)
      allow update: if isSignedIn()
                    && (resource.data.email == request.auth.token.email
                        || resource.data.invitedByUid == request.auth.uid);

      allow delete: if false; // Invites are permanent records
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
